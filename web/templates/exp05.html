<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>自动化寻找系统中的不公平样本</title>

  <!-- Mobile Specific Metas
================================================== -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Construction Html5 Template">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name=author content="Themefisher">
    <meta name=generator content="Themefisher Constra HTML Template v1.0">


    <!-- Template styles -->
    <link rel="stylesheet" href="../static/css/style.css">

    <!-- element-ui 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

        <!-- ============== js ================= -->
    <!-- vue.js -->
    <script src="../static/js/vue.js"></script>

    <!-- axios.js -->
    <script src="../static/plugins/axios/axios-0.18.0.js"></script>

    <!-- element-ui 组件库 -->
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    
</head>

<body>
<div class="body-inner" id="app">
    
    <el-container>
        <!-- Header -->
        <el-header>
            <h4>欢迎进入公平性审计实验</h4>
        </el-header>
        
        <!-- Main -->
        <el-main>
            <div class="task-area">
                <div class="task-title">
                    <h1>自动化寻找系统中的不公平样本</h1>
                </div>
                <div class="task-content">
                    <div class="task-content-description">
                        <p>一些说明</p>                       
                    </div>

                    <div class="task-content-form">
                        
                        <div class="task-form-area">
                            <div class="task-form-description">
                                <p>为寻找不公平样本的算法设定起始样本</p>
                            </div>

                            {#     ==================== form ======================                         #}
                            <div class="form-card">
                                <div class="task-form">

                                    <div class="form-card">
                            <el-form :model="form" :rules="rules2" ref="form" label-width="60px" hide-required-asterisk="true">
                                <div class="form-edit-area">
                                    <el-row :gutter="30">
                                        <el-col :span="12">
                                            <el-form-item label="年龄" prop="age">
                                                <el-input-number :step="1" :min="default_scope.age[0]" :max="default_scope.age[1]" v-model="form['age']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="每周工作时长" prop="hours-per-week">
                                                <el-input-number :step="1" :min="default_scope['hours-per-week'][0]" :max="default_scope['hours-per-week'][1]" v-model="form['hours-per-week']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="受教育时长" prop="education-num">
                                                <el-input-number :step="1" :min="default_scope['education-num'][0]" :max="default_scope['education-num'][1]" v-model="form['education-num']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="资产收益" prop="capital-gain">
                                                <el-input-number :step="1" :min="default_scope['capital-gain'][0]" :max="default_scope['capital-gain'][1]" v-model="form['capital-gain']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="资产损失" prop="capital-loss">
                                                <el-input-number :step="1" :min="default_scope['capital-loss'][0]" :max="default_scope['capital-loss'][1]" v-model="form['capital-loss']"></el-input-number>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="12">

                                            <el-form-item label="是否为白人" prop="race_White">
                                                 <el-select v-model="form['race_White']" placeholder="是否为白人">
                                                  <el-option v-if="default_scope['race_White'].includes(1)" label="白人" value="1"></el-option>
                                                  <el-option v-if="default_scope['race_White'].includes(0)" label="非白人" value="0"></el-option>
                                                </el-select>

                                            </el-form-item>
                                            <el-form-item label="性别" prop="sex_Male">
                                                <el-select v-model="form['sex_Male']" placeholder="请选择性别">
                                                  <el-option label="男" v-if="default_scope['sex_Male'].includes(1)" value="0"></el-option>
                                                  <el-option label="女" v-if="default_scope['sex_Male'].includes(0)" value="1"></el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-form-item label="婚姻状况" prop="marital-status">
                                                <el-select v-model="form['marital-status']" placeholder="请选择">
                                                    <el-option
                                                      v-for="item in filteredMaritalStatus"
                                                      :key="item.value"
                                                      :label="item.label"
                                                      :value="item.value">
                                                    </el-option>
                                                  </el-select>

                                            </el-form-item>
                                            <el-form-item label="工作类型" prop="workclass">
                                                 <el-select v-model="form['workclass']" placeholder="请选择">
                                                    <el-option
                                                      v-for="item in filteredWorkclass"
                                                      :key="item.value"
                                                      :label="item.label"
                                                      :value="item.value">
                                                    </el-option>
                                                  </el-select>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                </div>

                                <div class="form-submit-area" style="display: flex;justify-content: center">
                                    <el-form-item>
                                        <el-button type="primary" @click="seekUnfairPair('form')">开始寻找</el-button>
                                      </el-form-item>
                                </div>
                              </el-form>
                        </div>
                                </div>

                            </div>
                        </div>
{# =================== form1 和 form2  ========================   #}
                        <div class="task-form-area">
                            <el-row :gutter="40">
                        <el-col :span="12">
                        <div v-if="isShow" class="form-card">
                            <el-form :model="form1" :rules="rules2" ref="form1" label-width="60px" hide-required-asterisk="true">
                                <div class="form-edit-area">
                                    <el-row :gutter="30">
                                        <el-col :span="12">
                                            <el-form-item label="年龄" prop="age">
                                                <el-input-number :step="1" :min="1" :max="90" v-model="form1['age']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="每周工作时长" prop="hours-per-week">
                                                <el-input-number :step="1" :min="1" :max="99" v-model="form1['hours-per-week']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="受教育时长" prop="education-num">
                                                <el-input-number :step="1" :min="1" :max="16" v-model="form1['education-num']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="资产收益" prop="capital-gain">
                                                <el-input-number :step="1" :min="0" :max="99999" v-model="form1['capital-gain']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="资产损失" prop="capital-loss">
                                                <el-input-number :step="1" :min="1" :max="4356" v-model="form1['capital-loss']"></el-input-number>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="12">

                                            <el-form-item label="是否为白人" prop="race_White">
                                                 <el-select v-model="form1['race_White']" placeholder="是否为白人">
                                                  <el-option label="白人" value="White"></el-option>
                                                  <el-option label="非白人" value="Others"></el-option>
                                                </el-select>

                                            </el-form-item>
                                            <el-form-item label="性别" prop="sex_Male">
                                                <el-select v-model="form1['sex_Male']" placeholder="请选择性别">
                                                  <el-option label="男" value="Male"></el-option>
                                                  <el-option label="女" value="Female"></el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-form-item label="婚姻状况" prop="marital-status">
                                                <el-select v-model="form1['marital-status']" placeholder="请选择">
                                                    <el-option
                                                      v-for="item in maritalStatus"
                                                      :key="item.value"
                                                      :label="item.label"
                                                      :value="item.value">
                                                    </el-option>
                                                  </el-select>

                                            </el-form-item>
                                            <el-form-item label="工作类型" prop="workclass">
                                                 <el-select v-model="form1['workclass']" placeholder="请选择">
                                                    <el-option
                                                      v-for="item in workclass"
                                                      :key="item.value"
                                                      :label="item.label"
                                                      :value="item.value">
                                                    </el-option>
                                                  </el-select>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                </div>

                                <div class="form-submit-area">
                                    <el-row :gutter="10">
                                        <el-col :span="12">
                                            <el-form-item>
                                                <el-button type="primary" disabled="true" @click="submitForm1('form1')">查询</el-button>
                                              </el-form-item>
                                        </el-col>
                                        <el-col :span="12">
                                            <div style="float: left;">
                                                <span>分类结果为：</span><span>[[ result1 ]]</span>
                                            </div>
                                        </el-col>
                                    </el-row>
                                </div>
                              </el-form>
                        </div>
                    </el-col>
                        <el-col v-if="isShow" :span="12">

{#           ---------------------- 表2 ---------------------    #}
                        <div class="form-card">
                            <el-form :model="form2" :rules="rules2" ref="form2" label-width="60px" hide-required-asterisk="true">
                                <div class="form-edit-area">
                                    <el-row :gutter="30">
                                        <el-col :span="12">
                                            <el-form-item label="年龄" prop="age">
                                                <el-input-number :step="1" :min="1" :max="90" v-model="form2['age']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="每周工作时长" prop="hours-per-week">
                                                <el-input-number :step="1" :min="1" :max="99" v-model="form2['hours-per-week']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="受教育时长" prop="education-num">
                                                <el-input-number :step="1" :min="1" :max="16" v-model="form2['education-num']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="资产收益" prop="capital-gain">
                                                <el-input-number :step="1" :min="0" :max="99999" v-model="form2['capital-gain']"></el-input-number>
                                            </el-form-item>

                                            <el-form-item label="资产损失" prop="capital-loss">
                                                <el-input-number :step="1" :min="1" :max="4356" v-model="form2['capital-loss']"></el-input-number>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="12">

                                            <el-form-item label="是否为白人" prop="race_White">
                                                 <el-select v-model="form2['race_White']" placeholder="是否为白人">
                                                  <el-option label="白人" value="White"></el-option>
                                                  <el-option label="非白人" value="Others"></el-option>
                                                </el-select>

                                            </el-form-item>
                                            <el-form-item label="性别" prop="sex_Male">
                                                <el-select v-model="form2['sex_Male']" placeholder="请选择性别">
                                                  <el-option label="男" value="Male"></el-option>
                                                  <el-option label="女" value="Fema"></el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-form-item label="婚姻状况" prop="marital-status">
                                                <el-select v-model="form2['marital-status']" placeholder="请选择">
                                                    <el-option
                                                      v-for="item in maritalStatus"
                                                      :key="item.value"
                                                      :label="item.label"
                                                      :value="item.value">
                                                    </el-option>
                                                  </el-select>

                                            </el-form-item>
                                            <el-form-item label="工作类型" prop="workclass">
                                                 <el-select v-model="form2['workclass']" placeholder="请选择">
                                                    <el-option
                                                      v-for="item in workclass"
                                                      :key="item.value"
                                                      :label="item.label"
                                                      :value="item.value">
                                                    </el-option>
                                                  </el-select>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                </div>

                                <div class="form-submit-area">
                                    <el-row :gutter="10">
                                        <el-col :span="12">
                                            <el-form-item>
                                                <el-button type="primary" disabled="true" @click="submitForm2('form2')">查询</el-button>
                                              </el-form-item>
                                        </el-col>
                                        <el-col :span="12">
                                            <div style="float: left;">
                                                <span>分类结果为：</span><span>[[ result2 ]]</span>
                                            </div>
                                        </el-col>
                                    </el-row>
                                </div>
                              </el-form>
                        </div>
                    </el-col>

                    </el-row>
                        </div>

{#                        展示结果   #}
                        <div class="task-result-area">
                            <el-row :gutter="40">
                                <el-col :span="16">
                                    <div class="result-card">
                                        <div class="result-content">
                                            <span>公平性判别指标：</span><span>xxx</span>
                                        </div>                                                         
                                        <div class="result-content">
                                            <span>dx = </span><span>[[ dx ]]</span>
                                            <span>,dy = </span><span>[[ dy ]]</span>
                                            <span>,结果为</span><span>[[ fairness ]]</span>
                                        </div>                      
                                    </div>
                                </el-col>
                                <el-col :span="8">
                                        <el-button v-if="isShow" type="warning"  @click="goNext">下一步</el-button>
                                </el-col>
                            </el-row>
                        </div>
                    </div>             
                </div>               
            </div>   
        </el-main>

    </el-container>




</div>


    <!-- 创建Vue对象 -->
     <script>
          axios.get('/api/csrf/').then(response => {
              axios.defaults.headers.common['X-CSRFToken'] = response.data.csrfToken;
            });
        new Vue({
            el:"#app",
            delimiters:["[[", "]]"],
            data() {
                return {
                    sensitive: '',
                    isDisabled:false,

                    isShow:false,
                    {# 范围表单 #}
                    form: {
                        "age":'',
                        "capital-gain":'',
                        "capital-loss":'',
                        "education-num":'',
                        "hours-per-week":'',
                        "race_White":'',
                        "sex_Male":'',
                        "marital-status":[],
                        "workclass":[],

                    },
                    default_scope:{
                         "age": [1, 90],
                        "capital-gain":[0, 99999],
                        "capital-loss": [0, 4356],
                        "education-num":[1, 16],
                        "hours-per-week":[1, 99],
                        "marital-status": [],
                        "workclass":[],
                        "sex_Male": [0, 1],
                        "race_White":[0, 1],

                    },


                    form1: {
                        "age":'',
                        "capital-gain":'',
                        "capital-loss":'',
                        "education-num":'',
                        "hours-per-week":'',
                        "race_White":'',
                        "sex_Male":'',
                        "marital-status":'',
                        "workclass":'',
                    },
                    form2: {
                        "age":'',
                        "capital-gain":'',
                        "capital-loss":'',
                        "education-num":'',
                        "hours-per-week":'',
                        "race_White":'',
                        "sex_Male":'',
                        "marital-status":'',
                        "workclass":'',

                    },
                    {# 婚姻状况 #}
                    maritalStatus:[
                        { value: 'Divorced', label: '离异'},
                        { value: 'Married-AF-spouse', label: '军人家属婚姻'},
                        { value: 'Married-civ-spouse', label: '普通婚姻'},
                        { value: 'Married-spouse-absent', label: '已婚但夫妻异地'},
                        { value: 'Never-married', label: '未婚'},
                        { value: 'Separated', label: '分居'},
                        { value: 'Widowed', label: '丧偶'},],
                    {# 工作类型 #}
                    workclass:[
                        { value: 'Federal-gov', label: '联邦政府雇员'},
                        { value: 'Local-gov', label: '地方政府雇员'},
                        { value: 'Private', label: '私营企业'},
                        { value: 'Self-emp-inc', label: '自雇（收入较高）'},
                        { value: 'Self-emp-not-inc', label: '自雇（收入一般）'},
                        { value: 'State-gov', label: '州政府雇员'},
                        { value: 'Without-pay', label: '无报酬'},

                    ],
                    result:'',
                    result1:'',
                    result2:'',
                    dx:'xxx',
                    dy:'yyy',
                    fairness: '是',
                    initialValue:'',
                    rules: {},
                    rules2:{}
                };
            },
             computed: {
                filteredMaritalStatus() {
                  return this.maritalStatus.filter(item => this.default_scope['marital-status'].includes(item.value));
                },
                filteredWorkclass() {
                  return this.workclass.filter(item => this.default_scope.workclass.includes(item.value));
                }
              },
            created() {
                this.fetchData();
            },
            watch:{
                default_scope:{
                    handler(newVal){
                        //重新生成规则
                        this.initRules();
                    },
                    deep: true
                }
            },
            methods: {

                 {#初始化时获取数据#}
                fetchData(){
                    let _this = this;
                  axios.get("/api/exp05/?type=get_range").then(resp => {
                     console.log(this.default_scope)
                      _this.default_scope = resp.data;
                      console.log(this.default_scope)
                      console.log(resp.data)
                  });

                },

                 {#  初始化时构造规则函数 #}
                initRules() {
                  const attributes = ['age', 'hours-per-week', 'education-num', 'capital-gain', 'capital-loss', 'sex_Male', 'race_White'];
                  attributes.forEach(attr => {
                    this.rules[attr] = this.generateRules(attr);
                  });
                },
                generateRules(attribute) {
                  const [min, max] = this.default_scope[attribute];
                  return [
                    { type: 'number', min, max, message: `${attribute}应在${min}到${max}之间`, trigger: 'change' }
                  ];
                },

                {#    数值型通用规则#}
                validateRange(attribute, minLimit, maxLimit){
                  return (rule,value,callback)=>{
                      {# 这里的min指当前的左边框的值 #}
                      const min = this.form[attribute].scope[0];
                        const max = this.form[attribute].scope[1];
                      if(value < minLimit){
                          callback(new Error(`最低值不能小于${minLimit}`));
                      }else if(value > maxLimit){
                          callback(new Error(`最高值不能大于${maxLimit}`));
                      }else if(min >= max){
                          callback(new Error(`最低值必须小于最高值`));
                      }else{
                          callback()
                      }

              }
            },


                {#form提交，得到不公平对#}
                seekUnfairPair(formName){
                    this.$refs[formName].validate((valid) => {
                        if(valid){
                            console.log(this.form)
                            let _this = this;
                            axios.post("/api/exp05/",{action:"seek_unfair_pair",data:this.form})
                                .then(resp =>{
                                    _this.isShow=true;
                                    _this.form1 = resp.data[0];
                                    _this.form2 = resp.data[1];
                                    axios.post("/api/exp05/", {
                                        action:"check_unfair_pair", data1:_this.form1, data2:_this.form2
                                    }).then(response => {
                                        _this.result1 = response.data.result[0];
                                        _this.result2 = response.data.result[1];
                                        _this.dx = response.data.fair_data.dx.toFixed(10);
                                        _this.dy = response.data.fair_data.dy.toFixed(10);
                                        let flag = response.data.fair_data.fair_or_not;
                                        if(flag){
                                            _this.fairness = "公平";
                                        }else{
                                            _this.fairness = "不公平"
                                        }

                                        console.log(response);
                                    });
                                    console.log(resp.data);
                                    console.log(_this.form1);
                                    console.log(_this.form2);

                                });
                            alert('submit!');
                        }else{
                            console.log('error submit!');
                            return false;
                        }
                    });
                },

                {#form1 提交#}
                submitForm1(formName) {
                    this.$refs[formName].validate((valid) => {
                    if (valid) {
                        axios.post("/api/exp05/",{action: "check_unfair_pair", data})
                        alert('submit!');
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                    });
                },

                {#form2提交#}
                submitForm2(formName) {
                    this.$refs[formName].validate((valid) => {
                    if (valid) {
                        alert('submit!');
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                    });
                },


                resetForm(formName) {
                    this.$refs[formName].resetFields();
                },
                goNext(){
                    if (this.isShow) {
                        window.location.href = '/page06/';
                      } else {
                        alert('请先测试数据！');
                      }
                }


            }
        })


     </script>
</body>

</html>